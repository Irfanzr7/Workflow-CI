name: CI MLflow Project (Advanced)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train_and_deploy:
    runs-on: ubuntu-latest

    # üîë WAJIB: tracking URI ABSOLUTE (FIX run not found)
    env:
      MLFLOW_TRACKING_URI: "file:${{ github.workspace }}/mlruns"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Check environment
        run: |
          python --version
          pip --version
          echo "Workspace:"
          pwd
          ls -la
          echo "MLProject folder:"
          ls -la "MLProject (folder)"

      # ‚ö†Ô∏è OPTIONAL
      # Kalau requirements sudah didefinisikan di conda.yaml,
      # step ini SEBENARNYA BOLEH DIHAPUS
      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow

      # ‚úÖ SESUAI REVISI DICODING
      # ‚ùå TIDAK boleh python modeling_tuning.py
      # ‚úÖ WAJIB mlflow run
      - name: Run MLflow Project
        run: |
          python -m mlflow run "MLProject (folder)" --env-manager=local

      # (OPSIONAL) ambil run_id terakhir (kalau mau dipakai lanjut)
      - name: Get latest MLflow run_id
        id: get_run
        run: |
          python - <<'PY'
          import mlflow
          from mlflow.tracking import MlflowClient

          client = MlflowClient()
          exp = client.get_experiment_by_name("Default")
          exp_id = exp.experiment_id if exp else "0"

          runs = client.search_runs(
              [exp_id],
              order_by=["attributes.start_time DESC"],
              max_results=1
          )

          if not runs:
              raise SystemExit("No MLflow runs found")

          run_id = runs[0].info.run_id
          print("LATEST_RUN_ID=", run_id)

          with open("${GITHUB_OUTPUT}", "a") as f:
              f.write(f"run_id={run_id}\n")
          PY

      - name: CI finished
        run: echo "CI MLflow Project finished successfully ‚úÖ"
